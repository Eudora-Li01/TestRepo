# Copyright (c) Microsoft Corporation.
# Licensed under the MIT license.

trigger: none

pr: none

parameters:
#The target branch that you want to trigger the pipeline for
- name: TargetBranch
  displayName: Target branch for ACTS Repo
  type: string
  default: origin/main

variables:
- template: ../variables/*.yml
- template: ../variables/consumers/*.yml
- name: AcceleratorGitHubPath
  value: ./ACTS-VAT-Tax-Accelerator/DeliveryIP_GitHub

#The target tag that you want to trigger the pipeline for
- name: TargetTag
  displayName: Target tag for ACTS Repo
  type: string
  default: v1.0.0

resources:
  repositories:
  - repository: ACTSRepo 
    type: github
    endpoint: ACTS_Solutions
    name: microsoft/ACTS-Solutions
    ref: refs/heads/main
    branches:
      include:
        - main
        - VATTaxAccelerator
        - ProcurementAccelerator
        - PubSecInfoAssistant
        - BeneficialOwnershipEngine
        - eIAD

jobs:
- job: ResourceGroupCreation
  displayName: 'create resource group'
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - checkout: self
    persistCredentials: true
    clean: true
    fetchDepth: 1

- job: Deployment@v1
  displayName: 'Deploy service until Stream Analytics'
  dependsOn: ResourceGroupCreation
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - checkout: self
    persistCredentials: true
    clean: true
    fetchDepth: 1

- job: Deployment@v2
  displayName: 'Deploy service until ML compute for Ml workspace'
  dependsOn: ResourceGroupCreation
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - checkout: self
    persistCredentials: true
    clean: true
    fetchDepth: 1

- job: SynapseCreation
  displayName: 'Create Synapse workspace'
  dependsOn: Deployment@v1 & Deployment@v2
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - task: AzurePowerShell@5
    displayName: 'Create Data Factory Datasets'
    if: ${{ eq(env.DeployADFArtifacts, 'True') }}
    inputs:
      azureSubScription: 'ADOTestSubcription'
      ScriptType: 'InlineScript'
      Inline: |
        $datasetFolder  "$AcceleratorGitHubPath/synapse_adf_artifacts/integration_datasets/*"
        $files  Get-ChildItem -Path "$datasetFolder" -Include *.json
        foreach ($file in $files) {
          $name  $file.name
          $name_without_extension  $name.replace('.json','')
          $full_path  $datasetFolder + $name
          Set-AzDataFactoryV2Dataset -ResourceGroupName "$(PrimaryRgName)" -DataFactoryName "$(dataFactoryName)" -Name "$name_without_extension" -DefinitionFile "$full_path" -Force
        }
      azurePowerShellVersion: 'LatestVersion'
  # Create Synapse Linked Services to Data Lake, Landing Storage, Azure SQL, and Key Vault
  - task: AzurePowerShell@5
    displayName: 'Create Synapse Linked Services'
    if: ${{ eq(env.DeploySynapseArtifacts, 'True') }}
    inputs:
      azureSubscription: 'ADOTestSubcription'
      ScriptType: 'InlineScript'
      Inline: |
        $tokenOutput  Get-AzAccessToken -Resource "https://dev.azuresynapse.net"
        $token  $tokenOutput.token
        $auth  'Bearer ' + $token
        $headers  @{
          Authorization  "$auth"
        }

      # data lake
        $ls_body  (Get-Content "$AcceleratorGitHubPath/synapse_adf_artifacts/linked_services/adls.json") -Replace 'storageAccountName', '$(dataLakeName)' | Out-String
        $api_url  "https://$(synapseWorkspaceName).dev.azuresynapse.net/linkedServices/LS_DataLake?api-version2019-06-01-preview"
        Invoke-RestMethod -Method 'PUT' -Uri $api_url -Headers $headers -Body $ls_body
      
        # landing storage
        $ls_body  (Get-Content "$AcceleratorGitHubPath/synapse_adf_artifacts/linked_services/adls.json") -Replace 'storageAccountName', '$(landingStorageName)' | Out-String
        $api_url  "https://$(synapseWorkspaceName).dev.azuresynapse.net/linkedServices/LS_LandingStorage?api-version2019-06-01-preview"
        Invoke-RestMethod -Method 'PUT' -Uri $api_url -Headers $headers -Body $ls_body
      
        # azure sql
        (Get-Content "$AcceleratorGitHubPath/synapse_adf_artifacts/linked_services/azuresql.json") -Replace 'azureSQLServerName', '$(azureSQLServerName)' | Set-Content "$(System.DefaultWorkingDirectory)/DeliveryIP_GitHub/synapse_adf_artifacts/linked_services/azuresql.json"
        $ls_body  (Get-Content "$AcceleratorGitHubPath/synapse_adf_artifacts/linked_services/azuresql.json") -Replace 'azureSQLServerDBName', '$(azureSQLServerDBName)' | Out-String
        $api_url  "https://$(synapseWorkspaceName).dev.azuresynapse.net/linkedServices/LS_SQL_MetadataControl?api-version2019-06-01-preview"
        Invoke-RestMethod -Method 'PUT' -Uri $api_url -Headers $headers -Body $ls_body
      
        # key vault
        $ls_body  (Get-Content "$AcceleratorGitHubPath/synapse_adf_artifacts/linked_services/keyvault.json") -Replace 'keyVaultName', '$(keyVaultName)' | Out-String
        $api_url  "https://$(synapseWorkspaceName).dev.azuresynapse.net/linkedServices/LS_KeyVault?api-version2019-06-01-preview"
        Invoke-RestMethod -Method 'PUT' -Uri $api_url -Headers $headers -Body $ls_body
      
        # cognitive service
        (Get-Content "$AcceleratorGitHubPath/synapse_adf_artifacts/linked_services/cognitiveservice.json") -Replace 'cognitiveServiceName', '$(cognitiveServiceName)' | Set-Content "$(System.DefaultWorkingDirectory)/DeliveryIP_GitHub/synapse_adf_artifacts/linked_services/cognitiveservice.json"
        (Get-Content "$AcceleratorGitHubPath/synapse_adf_artifacts/linked_services/cognitiveservice.json") -Replace 'subID', '$(SUBSCRIPTION_ID)' | Set-Content "$(System.DefaultWorkingDirectory)/DeliveryIP_GitHub/synapse_adf_artifacts/linked_services/cognitiveservice.json"
        (Get-Content "$AcceleratorGitHubPath/synapse_adf_artifacts/linked_services/cognitiveservice.json") -Replace 'resourceGroupName', '$(PrimaryRgName)' | Set-Content "$(System.DefaultWorkingDirectory)/DeliveryIP_GitHub/synapse_adf_artifacts/linked_services/cognitiveservice.json"
        $ls_body  (Get-Content "$AcceleratorGitHubPath/synapse_adf_artifacts/linked_services/cognitiveservice.json") -Replace 'azureLocation', '$(azureResourceLocation)' | Out-String
        $api_url  "https://$(synapseWorkspaceName).dev.azuresynapse.net/linkedServices/LS_CognitiveService?api-version2019-06-01-preview"
        Invoke-RestMethod -Method 'PUT' -Uri $api_url -Headers $headers -Body $ls_body

        if ($env:DeployMLWorkspace -eq "True") { 
          # create ml workspace linked service
          (Get-Content "$AcceleratorGitHubPath/synapse_adf_artifacts/linked_services/machineLearningWorkspace.json") -Replace 'resourceGroupNameInput', '$(MlRgName)' | Set-Content "$(System.DefaultWorkingDirectory)/DeliveryIP_GitHub/synapse_adf_artifacts/linked_services/machineLearningWorkspace.json"
          (Get-Content "$AcceleratorGitHubPath/synapse_adf_artifacts/linked_services/machineLearningWorkspace.json") -Replace 'subID', '$(SUBSCRIPTION_ID)' | Set-Content "$(System.DefaultWorkingDirectory)/DeliveryIP_GitHub/synapse_adf_artifacts/linked_services/machineLearningWorkspace.json"
          (Get-Content "$AcceleratorGitHubPath/synapse_adf_artifacts/linked_services/machineLearningWorkspace.json") -Replace 'MachineLearningWorkspaceName', '$(mlWorkspaceName)' | Set-Content "$(System.DefaultWorkingDirectory)/DeliveryIP_GitHub/synapse_adf_artifacts/linked_services/machineLearningWorkspace.json"

          $ls_body  Get-Content "$AcceleratorGitHubPath/synapse_adf_artifacts/linked_services/machineLearningWorkspace.json" | Out-String

          $api_url  "https://$(synapseWorkspaceName).dev.azuresynapse.net/linkedServices/LS_MachineLearningWorkspace?api-version2019-06-01-preview"
          
          Invoke-RestMethod -Method 'PUT' -Uri $api_url -Headers $headers -Body $ls_body
        }
      azurePowerShellVersion: 'LatestVersion'
  
  - task: AzurePowerShell@5
    displayName: 'Create Synapse Datasets and Notebooks'
    if: ${{ eq(env.DeploySynapseArtifacts, 'True') }}
    inputs:
      azureSubscription: 'ADOTestSubcription'
      ScriptType: 'InlineScript'
      Inline: |
        $notebookFolder  "$AcceleratorGitHubPath/synapse_adf_artifacts/notebooks/"
        $files  Get-ChildItem -Path "$notebookFolder" -Exclude "NotDeployed"

        foreach($file in $files) {
          $filename  $file.name
          $full_path  $notebookFolder + $filename
          
          $folder_filename  $filename.split('&')
          $synapsefolder  $folder_filename[0]
          $synapseNbName  $folder_filename[1].replace('.ipynb','')
          
          Set-AzSynapseNotebook -WorkspaceName ${{ env.synapseWorkspaceName }} -Name "$synapseNbName" -DefinitionFile "$full_path" -FolderPath "$synapsefolder" -SparkPoolName "defaultSpark33" -ExecutorCount 1 -ExecutorSize "Medium"
        }

        $tokenOutput  Get-AzAccessToken -Resource "https://dev.azuresynapse.net"
        $token  $tokenOutput.token
        $auth  'Bearer ' + $token
        $headers  @{
          Authorization  "$auth"
        }

        $datasetFolder  "$AcceleratorGitHubPath/synapse_adf_artifacts/integration_datasets/*"
        $files  Get-ChildItem -Path "$datasetFolder" -Include *.json

        foreach($file in $files) {
          $name  $file.name
          $name_without_extension  $name.replace('.json','')
          $full_path  $datasetFolder + $name
          $dataset_body  (Get-Content "$full_path") | Out-String
      azurePowerShellVersion: 'latest'
  
  - task: AzurePowerShell@5
    displayName: 'Create Data Factory Pipelines, Dataflows, and Triggers'
    inputs:
      azureSubscription: 'ADOTestSubcription'
      ScriptType: 'InlineScript'
      Inline: |
        $datasetFolder  "$AcceleratorGitHubPath/synapse_adf_artifacts/integration_datasets/SourceToLanding/*"
        $files  Get-ChildItem -Path "$datasetFolder" -Include *.json   

        foreach($file in $files) {
          $name  $file.name
          $name_without_extension  $name.replace('.json','')
          $full_path  $datasetFolder + $name
          Set-AzDataFactoryV2Dataset -ResourceGroupName "$(PrimaryRgName)" -DataFactoryName "$(dataFactoryName)" -Name "$name_without_extension" -DefinitionFile "$full_path" -Force
        }

        $dataflowFolder  "$AcceleratorGitHubPath/synapse_adf_artifacts/dataflows/"
        $files  Get-ChildItem -Path "$dataflowFolder" -Exclude "NotDeployed"

        foreach($file in $files) {
          $name  $file.name
          $name_without_extension  $name.replace('.json','')
          $full_path  $dataflowFolder + $name
          Set-AzDataFactoryV2DataFlow -ResourceGroupName "$(PrimaryRgName)" -DataFactoryName "$(dataFactoryName)" -Name $name_without_extension -DefinitionFile "$full_path" -Force
        }

        $pipelineFolder  "$AcceleratorGitHubPath/synapse_adf_artifacts/pipelines/"
        $files  Get-ChildItem -Path "$pipelineFolder" -Exclude "NotDeployed", "*_Synapse.json" | Sort-Object -Property Name -Descending

        foreach($file in $files) {
          $name  $file.name
          $name_without_extension  $name.replace('_ADF.json','').replace('.json','')
          $full_path  $pipelineFolder + $name
          Set-AzDataFactoryV2Pipeline -ResourceGroupName "$(PrimaryRgName)" -DataFactoryName "$(dataFactoryName)" -Name $name_without_extension -DefinitionFile "$full_path" -Force
        }

        (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/triggers/TR_blobCreatedEvent.json) -Replace 'resourceGroupName', '$(PrimaryRgName)' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/triggers/TR_blobCreatedEvent.json
        (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/triggers/TR_blobCreatedEvent.json) -Replace 'subID', '$(SubscriptionID)' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/triggers/TR_blobCreatedEvent.json
        (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/triggers/TR_blobCreatedEvent.json) -Replace 'landingStorageName', '$(landingStorageName)' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/triggers/TR_blobCreatedEvent.json
        Set-AzDataFactoryV2Trigger -ResourceGroupName "$(PrimaryRgName)" -DataFactoryName "$(dataFactoryName)" -Name "TR_blobCreatedEvent" `
        -DefinitionFile "$AcceleratorGitHubPath/synapse_adf_artifacts/triggers/TR_blobCreatedEvent.json" -Force
      # start trigger
        Start-AzDataFactoryV2Trigger -ResourceGroupName "$(PrimaryRgName)" -DataFactoryName "$(dataFactoryName)" -TriggerName "TR_blobCreatedEvent" -Force
      azPSVersion: latest
  
  - task: AzureResourceManagerTemplateDeployment@3
    displayName: 'Deploy ML Workspace Storage Account'
    if: ${{ eq(env.DeployMLWorkspace, 'True') }}
    inputs:
      deploymentScope: 'Resource Group'
      azureResourceManagerConnection: 'ADOTestSubcription'
      #subscriptionId: ${{ secrets.SUBSCRIPTION_ID }}
      resourceGroupName: ${{ variables.MlRgName }}
      location: ${{ variables.azureResourceLocation }}
      templateLocation: 'FilePath'
      csmFile: '$AcceleratorGitHubPath/bicep_templates/storageaccount.bicep'
      csmParametersFile: '$AcceleratorGitHubPath/bicep_parameters/${{ inputs.envFolderPath }}/mlstorage.json'
      overrideParameters: >
        -location ${{ env.azureResourceLocation }}
        -storageAccountName ${{ env.mlStorageName }}
        -DeployWithCustomNetworking ${{ env.DeployWithCustomNetworking }}
        -CreatePrivateEndpoints ${{ env.CreatePrivateEndpoints }}
        -CreatePrivateEndpointsInSameRgAsResource ${{ env.CreatePrivateEndpointsInSameRgAsResource }}
        -UseManualPrivateLinkServiceConnections ${{ env.UseManualPrivateLinkServiceConnections }}
        -VnetforPrivateEndpointsRgName ${{ env.VnetforPrivateEndpointsRgName }}
        -VnetforPrivateEndpointsName ${{ env.VnetforPrivateEndpointsName }}
        -PrivateEndpointSubnetName ${{ env.PrivateEndpointSubnetName }}
        -DNS_ZONE_SUBSCRIPTION_ID '${{ secrets.DNS_ZONE_SUBSCRIPTION_ID }}'
        -PrivateDNSZoneRgName ${{ env.PrivateDNSZoneRgName }}
        -PrivateEndpointId ${{ env.PrivateEndpointId }}
        -DeployResourcesWithPublicAccess ${{ env.DeployResourcesWithPublicAccess }}
        -AllowAccessToIpRange ${{ env.AllowAccessToIpRange }}
        -IpRangeCidr ${{ env.IpRangeCidr }}
        -DeployLogAnalytics ${{ env.DeployLogAnalytics }}
        -logAnalyticsRG ${{ env.PrimaryRgName }}
        -logAnalyticsName ${{ env.logAnalyticsName }}
      deploymentMode: 'Incremental'
      deploymentName: 'DeployMLWorkspaceStorageAccount'

  - task: AzureResourceManagerTemplateDeployment@3
    displayName: Deploy ML Workspace App Insights
    if: ${{ eq(env.DeployMLWorkspace, 'True') }}
    inputs:
      deploymentScope: 'Resource Group'
      azureResourceManagerConnection: 'ADOTestSubcription'
      resourceGroupName: ${{ env.MlRgName }}
      location: ${{ env.azureResourceLocation }}
      templateLocation: 'FilePath'
      csmFile: '$AcceleratorGitHubPath/bicep_templates/appinsights.bicep'
      csmParametersFile: '$AcceleratorGitHubPath/bicep_parameters/${{ inputs.envFolderPath }}/mlappinsights.json'
      overrideParameters: >
        -location ${{ env.azureResourceLocation }}
        -appInsightsName ${{ env.mlAppInsightsName }}
        -DeployLogAnalytics ${{ env.DeployLogAnalytics }}
        -logAnalyticsName ${{ env.logAnalyticsName }}
        -logAnalyticsRG ${{ env.PrimaryRgName }}
        -DeployResourcesWithPublicAccess ${{ env.DeployResourcesWithPublicAccess }}
      deploymentMode: 'Incremental'
      deploymentName: 'MLWorkspaceAppInsightsDeployment'
  
  - task: AzureResourceManagerTemplateDeployment@3
    displayName: Deploy Container Registry for ML Workspace
    if: ${{ eq(env.DeployMLWorkspace, 'True') }}
    inputs:
      deploymentScope: 'Resource Group'
      azureResourceManagerConnection: 'ADOTestSubcription'
      resourceGroupName: ${{ env.MlRgName }}
      location: ${{ env.azureResourceLocation }}
      templateLocation: 'FilePath'
      csmFile: '$AcceleratorGitHubPath/bicep_templates/container_registry.bicep'
      csmParametersFile: '$AcceleratorGitHubPath/bicep_parameters/${{ inputs.envFolderPath }}/aml_container_registry.json'
      overrideParameters: >
        -location ${{ env.azureResourceLocation }}
        -containerRegistryName ${{ env.mlContainerRegistryName }}
        -DeployWithCustomNetworking ${{ env.DeployWithCustomNetworking }}
        -CreatePrivateEndpoints ${{ env.CreatePrivateEndpoints }}
        -CreatePrivateEndpointsInSameRgAsResource ${{ env.CreatePrivateEndpointsInSameRgAsResource }}
        -UseManualPrivateLinkServiceConnections ${{ env.UseManualPrivateLinkServiceConnections }}
        -VnetforPrivateEndpointsRgName ${{ env.VnetforPrivateEndpointsRgName }}
        -VnetforPrivateEndpointsName ${{ env.VnetforPrivateEndpointsName }}
        -PrivateEndpointSubnetName ${{ env.PrivateEndpointSubnetName }}
        -DNS_ZONE_SUBSCRIPTION_ID '${{ secrets.DNS_ZONE_SUBSCRIPTION_ID }}'
        -PrivateDNSZoneRgName ${{ env.PrivateDNSZoneRgName }}
        -PrivateEndpointId ${{ env.PrivateEndpointId }}
        -DeployResourcesWithPublicAccess ${{ env.DeployResourcesWithPublicAccess }}
        -AllowAccessToIpRange ${{ env.AllowAccessToIpRange }}
        -IpRangeCidr ${{ env.IpRangeCidr }}
      deploymentMode: 'Incremental'
      deploymentName: 'MLWorkspaceContainerRegistryDeployment'
  
  - task: AzureResourceManagerTemplateDeployment@3
    displayName: Deploy Key Vault for ML Workspace
    if: ${{ eq(env.DeployMLWorkspace, 'True') }}
    inputs:
      deploymentScope: 'Resource Group'
      azureResourceManagerConnection: 'ADOTestSubcription'
      resourceGroupName: ${{ env.MlRgName }}
      location: ${{ env.azureResourceLocation }}
      templateLocation: 'FilePath'
      csmFile: '$AcceleratorGitHubPath/bicep_templates/keyvault.bicep'
      csmParametersFile: '$AcceleratorGitHubPath/bicep_parameters/${{ inputs.envFolderPath }}/mlWorkspaceKeyVault.json'
      overrideParameters: >
        -location ${{ env.azureResourceLocation }}
        -keyVaultName ${{ env.mlWorkspaceKeyVaultName }}
        -DeployLogAnalytics ${{ env.DeployLogAnalytics }}
        -logAnalyticsRG ${{ env.PrimaryRgName }}
        -logAnalyticsName ${{ env.logAnalyticsName }}
        -DeployWithCustomNetworking ${{ env.DeployWithCustomNetworking }}
        -CreatePrivateEndpoints ${{ env.CreatePrivateEndpoints }}
        -CreatePrivateEndpointsInSameRgAsResource ${{ env.CreatePrivateEndpointsInSameRgAsResource }}
        -UseManualPrivateLinkServiceConnections ${{ env.UseManualPrivateLinkServiceConnections }}
        -VnetforPrivateEndpointsRgName ${{ env.VnetforPrivateEndpointsRgName }}
        -VnetforPrivateEndpointsName ${{ env.VnetforPrivateEndpointsName }}
        -PrivateEndpointSubnetName ${{ env.PrivateEndpointSubnetName }}
        -DNS_ZONE_SUBSCRIPTION_ID '${{ secrets.DNS_ZONE_SUBSCRIPTION_ID }}'
        -PrivateDNSZoneRgName ${{ env.PrivateDNSZoneRgName }}
        -PrivateEndpointId ${{ env.PrivateEndpointId }}
        -DeployResourcesWithPublicAccess ${{ env.DeployResourcesWithPublicAccess }}
        -AllowAccessToIpRange ${{ env.AllowAccessToIpRange }}
        -IpRangeCidr ${{ env.IpRangeCidr }}
      deploymentMode: 'Incremental'
      deploymentName: 'MLWorkspaceKeyVaultDeployment'

  - task: AzureResourceManagerTemplateDeployment@3
    displayName: Deploy ML Workspace
    if: ${{ eq(env.DeployMLWorkspace, 'True') }}
    inputs:
      deploymentScope: 'Resource Group'
      azureResourceManagerConnection: 'ADOTestSubcription'
      resourceGroupName: ${{ env.MlRgName }}
      location: ${{ env.azureResourceLocation }}
      templateLocation: 'FilePath'
      csmFile: '$AcceleratorGitHubPath/bicep_templates/mlworkspace.bicep'
      csmParametersFile: '$AcceleratorGitHubPath/bicep_parameters/${{ inputs.envFolderPath }}/mlworkspace.json'
      overrideParameters: >
        -location ${{ env.azureResourceLocation }}
        -mlWorkspaceName ${{ env.mlWorkspaceName }}
        -mlStorageAccountName ${{ env.mlStorageName }}
        -appInsightsName ${{ env.mlAppInsightsName }}
        -contanierrRegistryName ${{ env.mlContainerRegistryName }}
        -keyVaultName ${{ env.mlWorkspaceKeyVaultName }}
        -dataLakeName ${{ env.dataLakeName }}
        -PrimaryRgName ${{ env.PrimaryRgName }}
        -DeployWithCustomNetworking ${{ env.DeployWithCustomNetworking }}
        -CreatePrivateEndpoints ${{ env.CreatePrivateEndpoints }}
        -CreatePrivateEndpointsInSameRgAsResource ${{ env.CreatePrivateEndpointsInSameRgAsResource }}
        -UseManualPrivateLinkServiceConnections ${{ env.UseManualPrivateLinkServiceConnections }}
        -VnetforPrivateEndpointsRgName ${{ env.VnetforPrivateEndpointsRgName }}
        -VnetforPrivateEndpointsName ${{ env.VnetforPrivateEndpointsName }}
        -PrivateEndpointSubnetName ${{ env.PrivateEndpointSubnetName }}
        -DNS_ZONE_SUBSCRIPTION_ID '${{ secrets.DNS_ZONE_SUBSCRIPTION_ID }}'
        -PrivateDNSZoneRgName ${{ env.PrivateDNSZoneRgName }}
        -PrivateEndpointId ${{ env.PrivateEndpointId }}
        -RedeploymentAfterNetworkingIsSetUp ${{ env.RedeploymentAfterNetworkingIsSetUp }}
        -DeployMLWorkspaceInManagedVnet ${{ env.DeployMLWorkspaceInManagedVnet }}
      deploymentMode: 'Incremental'
      deploymentName: 'MLWorkspaceDeployment'

    - task: AzureResourceManagerTemplateDeployment@3
      displayName: Deploy ML Compute for ML Workspace and Optionally RBAC for Compute
      if: ${{ eq(env.DeployMLWorkspace, 'True') }}
      inputs:
        deploymentScope: 'Resource Group'
        azureResourceManagerConnection: 'ADOTestSubcription'
        resourceGroupName: ${{ env.MlRgName }}
        location: ${{ env.azureResourceLocation }}
        templateLocation: 'FilePath'
        csmFile: '$AcceleratorGitHubPath/bicep_templates/ml_compute.bicep'
        csmParametersFile: '$AcceleratorGitHubPath/bicep_parameters/${{ inputs.envFolderPath }}/ml_compute.json'
        overrideParameters: >
          -location ${{ env.azureResourceLocation }}
          -mlWorkspaceName ${{ env.mlWorkspaceName }}
          -mlStorageAccountName ${{ env.mlStorageName }}
          -appInsightsName ${{ env.mlAppInsightsName }}
          -contanierrRegistryName ${{ env.mlContainerRegistryName }}
          -keyVaultName ${{ env.mlWorkspaceKeyVaultName }}
          -dataLakeName ${{ env.dataLakeName }}
          -PrimaryRgName ${{ env.PrimaryRgName }}
          -DeployWithCustomNetworking ${{ env.DeployWithCustomNetworking }}
          -CreatePrivateEndpoints ${{ env.CreatePrivateEndpoints }}
          -CreatePrivateEndpointsInSameRgAsResource ${{ env.CreatePrivateEndpointsInSameRgAsResource }}
          -UseManualPrivateLinkServiceConnections ${{ env.UseManualPrivateLinkServiceConnections }}
          -VnetforPrivateEndpointsRgName ${{ env.VnetforPrivateEndpointsRgName }}
          -VnetforPrivateEndpointsName ${{ env.VnetforPrivateEndpointsName }}
          -PrivateEndpointSubnetName ${{ env.PrivateEndpointSubnetName }}
          -DNS_ZONE_SUBSCRIPTION_ID '${{ secrets.DNS_ZONE_SUBSCRIPTION_ID }}'
          -PrivateDNSZoneRgName ${{ env.PrivateDNSZoneRgName }}
          -PrivateEndpointId ${{ env.PrivateEndpointId }}
          -RedeploymentAfterNetworkingIsSetUp ${{ env.RedeploymentAfterNetworkingIsSetUp }}
          -DeployMLWorkspaceInManagedVnet ${{ env.DeployMLWorkspaceInManagedVnet }}
        deploymentMode: 'Incremental'
        deploymentName: 'MLWorkspaceDeployment'
    
    - displayName: 'Refresh OIDC Credentials'
      env:
        AZURE_SERVICE_PRINCIPAL_CLIENT_ID: ${{ secrets.AZURE_SERVICE_PRINCIPAL_CLIENT_ID }}
        AZURE_TENANT_ID: ${{ secrets.TENANT_ID }}
        AZURE_SUBSCRIPTION_ID: ${{ secrets.SUBSCRIPTION_ID }}
      script: |
        az login --service-principal -username $AZURE_SERVICE_PRINCIPAL_CLIENT_ID --tenant $AZURE_TENANT_ID --password ${{ secrets.AZURE_SERVICE_PRINCIPAL_CLIENT_SECRET }}
      
    - task: AzurePowerShell@5
      displayName: 'Enable Azure Container Registry for ML Workspace Behind Virtual Network'
      if: ${{ eq(env.DeployMLWorkspace, 'True') && eq(env.CreatePrivateEndpoints, 'True')  && eq(env.DeployWithCustomNetworking, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          az extension add -n ml
          az ml workspace update --name ${{ env.mlWorkspaceName }} --resource-group ${{ env.MlRgName }} --image-build-compute image-build-compute-cluster
        azurePowerShellVersion: 'LatestVersion'
    
    - task: AzurePowerShell@5
      displayName: 'Create Synapse Managed Private Endpoint to Data Lake Storage Account - DFS endpoint'
      if: ${{ eq(env.DeploySynapse, 'True') && eq(env.DeployDataLake, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_dfs.json) -Replace 'resourceGroupName', '${{ env.PrimaryRgName }}' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_dfs_1.json
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_dfs_1.json) -Replace 'subID', '${{ secrets.SUBSCRIPTION_ID }}' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_dfs_1.json
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_dfs_1.json) -Replace 'storageAccountName', '${{ env.dataLakeName }}' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_dfs_1.json
          New-AzSynapseManagedPrivateEndpoint -WorkspaceName ${{ env.synapseWorkspaceName }} -Name MPE_DataLake_DFS -DefinitionFile "$AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_dfs_1.json"
        azurePowerShellVersion: 'LatestVersion'

    - task: AzurePowerShell@5
      displayName: 'Create Synapse Managed Private Endpoint to Data Lake Storage Account - Blob endpoint'
      if: ${{ eq(env.DeploySynapse, 'True') && eq(env.DeployDataLake, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_blob.json) -Replace 'resourceGroupName', '${{ env.PrimaryRgName }}' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_blob_1.json
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_blob_1.json) -Replace 'subID', '${{ secrets.SUBSCRIPTION_ID }}' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_blob_1.json
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_blob_1.json) -Replace 'storageAccountName', '${{ env.dataLakeName }}' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_blob_1.json
          New-AzSynapseManagedPrivateEndpoint -WorkspaceName ${{ env.synapseWorkspaceName }} -Name MPE_DataLake_Blob -DefinitionFile "$AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_blob_1.json"
        azurePowerShellVersion: 'LatestVersion'

    - task: AzurePowerShell@5
      displayName: 'Create Synapse Managed Private Endpoint to Landing Storage - DFS endpoint'
      if: ${{ eq(env.DeploySynapse, 'True') && eq(env.DeployLandingStorage, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_dfs.json) -Replace 'resourceGroupName', '${{ env.PrimaryRgName }}' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_dfs_2.json
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_dfs_2.json) -Replace 'subID', '${{ secrets.SUBSCRIPTION_ID }}' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_dfs_2.json
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_dfs_2.json) -Replace 'storageAccountName', '${{ env.landingStorageName }}' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_dfs_2.json
          New-AzSynapseManagedPrivateEndpoint -WorkspaceName ${{ env.synapseWorkspaceName }} -Name MPE_LandingStorage_DFS -DefinitionFile "$AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_dfs_2.json"
        azurePowerShellVersion: 'LatestVersion'

    - task: AzurePowerShell@5
      displayName: 'Create Synapse Managed Private Endpoint to Landing Storage - Blob endpoint'
      if: ${{ eq(env.DeploySynapse, 'True') && eq(env.DeployLandingStorage, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_blob.json) -Replace 'resourceGroupName', '${{ env.PrimaryRgName }}' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_blob_2.json
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_blob_2.json) -Replace 'subID', '${{ secrets.SUBSCRIPTION_ID }}' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_blob_2.json
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_blob_2.json) -Replace 'storageAccountName', '${{ env.landingStorageName }}' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_blob_2.json
          New-AzSynapseManagedPrivateEndpoint -WorkspaceName ${{ env.synapseWorkspaceName }} -Name MPE_LandingStorage_Blob -DefinitionFile "$AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_blob_2.json"
        azurePowerShellVersion: 'LatestVersion'

    - task: AzurepowerShell@5
      displayName: 'Create Synapse Managed Private Endpoint to Key Vault'
      if: ${{ eq(env.DeploySynapse, 'True') && eq(env.DeployKeyVault, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/keyvault.json) -Replace 'resourceGroupName', '${{ env.PrimaryRgName }}' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/keyvault.json
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/keyvault.json) -Replace 'subID', '${{ secrets.SUBSCRIPTION_ID }}' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/keyvault.json
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/keyvault.json) -Replace 'keyVaultName', '${{ env.keyVaultName }}' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/keyvault.json
          New-AzSynapseManagedPrivateEndpoint -WorkspaceName ${{ env.synapseWorkspaceName }} -Name MPE_KeyVault -DefinitionFile "$AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/keyvault.json"
        azurePowerShellVersion: 'LatestVersion'

    - task: AzurePowerShell@5
      displayName: 'Create Synapse Managed Private Endpoint to Azure SQL'
      if: ${{ eq(env.DeploySynapse, 'True') && eq(env.DeployAzureSQL, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/azuresql.json) -Replace 'resourceGroupName', '${{ env.PrimaryRgName }}' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/azuresql.json
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/azuresql.json) -Replace 'subID', '${{ secrets.SUBSCRIPTION_ID }}' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/azuresql.json
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/azuresql.json) -Replace 'azureSQLServerName', '${{ env.azureSQLServerName }}' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/azuresql.json
          New-AzSynapseManagedPrivateEndpoint -WorkspaceName ${{ env.synapseWorkspaceName }} -Name MPE_AzureSQL -DefinitionFile "$AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/azuresql.json"
        azurePowerShellVersion: 'LatestVersion'
    
    - task: AzurePowerShell@5
      displayName: 'Create Synapse Managed Private Endpoint to Purview'
      if: ${{ eq(env.DeploySynapse, 'True') && eq(env.DeployPurview, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/purview.json) -Replace 'resourceGroupName', '${{ env.PrimaryRgName }}' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/purview.json
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/purview.json) -Replace 'subID', '${{ secrets.SUBSCRIPTION_ID }}' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/purview.json
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/purview.json) -Replace 'purviewName', '${{ env.purviewName }}' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/purview.json
          New-AzSynapseManagedPrivateEndpoint -WorkspaceName ${{ env.synapseWorkspaceName }} -Name MPE_Purview1 -DefinitionFile "$AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/purview.json"
        
          $purview  Get-AzResource -Name ${{ env.purviewName }} -ResourceGroupName ${{ env.PrimaryRgName }} -ResourceType Microsoft.Purview/accounts -ExpandProperties
          $purviewStorageResourceId  $purview.Properties.managedResources.storageAccount
          $purviewStorageName  $purviewStorageResourceId.split('/')[-1]  
          $purviewManagedRgName  $purview.Properties.managedResourceGroupName

          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/queue.json) -Replace 'resourceGroupName', "$purviewManagedRgName" | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/queue_purviewStorage.json
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/queue_purviewStorage.json) -Replace 'subID', '${{ secrets.SUBSCRIPTION_ID }}' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/queue_purviewStorage.json
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/queue_purviewStorage.json) -Replace 'storageAccountName', "$purviewStorageName" | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/queue_purviewStorage.json
          New-AzSynapseManagedPrivateEndpoint -WorkspaceName ${{ env.synapseWorkspaceName }} -Name MPE_PurviewStorage_Queue -DefinitionFile "$AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/queue_purviewStorage.json"

          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_blob.json) -Replace 'resourceGroupName', "$purviewManagedRgName" | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_blob_purviewStorage.json
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_blob_purviewStorage.json) -Replace 'subID', '${{ secrets.SUBSCRIPTION_ID }}' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_blob_purviewStorage.json
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_blob_purviewStorage.json) -Replace 'storageAccountName', "$purviewStorageName" | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_blob_purviewStorage.json
          New-AzSynapseManagedPrivateEndpoint -WorkspaceName ${{ env.synapseWorkspaceName }} -Name MPE_PurviewStorage_Blob -DefinitionFile "$AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/adls_blob_purviewStorage.json"
        azurePowerShellVersion: 'LatestVersion'
    
    - task: AzurePowerShell@5
      displayName: 'Create Synapse Managed Private Endpoint to ML Workspace'
      if: ${{ eq(env.DeploySynapse, 'True') && eq( env.DeployMLWorkspace, 'True') && eq(env.DeployWithCustomNetworking, 'True') && eq(env.CreatePrivateEndpoints, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/machineLearningWorkspace.json) -Replace 'resourceGroupName', '${{ env.PrimaryRgName }}' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/machineLearningWorkspace.json
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/machineLearningWorkspace.json) -Replace 'subID', '${{ secrets.SUBSCRIPTION_ID }}' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/machineLearningWorkspace.json
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/machineLearningWorkspace.json) -Replace 'mlWorkspaceName', '${{ env.mlWorkspaceName }}' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/machineLearningWorkspace.json
          New-AzSynapseManagedPrivateEndpoint -WorkspaceName ${{ env.synapseWorkspaceName }} -Name MPE_MLWorkspace -DefinitionFile "$AcceleratorGitHubPath/synapse_adf_artifacts/managed_private_endpoints/machineLearningWorkspace.json"
        azurePowerShellVersion: 'LatestVersion'
 
    # feature flag for Synapse only (No ADF Deployment). Adding Metadata Control Pipelines and Blob Created Trigger
    - task: AzurePowerShell@5
      displayName: 'Create Synapse Metadata Control Pipelines, Dataflow, and Blob Created Trigger'
      if: ${{ eq(env.DeployMetadataDrivenPipelinesToSynapse, 'True') && eq(env.DeploySynapseArtifacts, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          $tokenOutput  Get-AzAccessToken -Resource "https://dev.azuresynapse.net"
          $token  $tokenOutput.token
          $auth  'Bearer ' + $token
          $headers  @{
            Authorization  "$auth"
          }

        # oracle
          Set-AzSynapseLinkedService -WorkspaceName ${{ env.synapseWorkspaceName }} -Name 'LS_Oracle' -DefinitionFile "$AcceleratorGitHubPath/synapse_adf_artifacts/linked_services/oracle.json"

          $datasetFolder  "$AcceleratorGitHubPath/synapse_adf_artifacts/integration_datasets/SourceToLanding/*"
          $files  Get-ChildItem -Path "$datasetFolder" -Include *.json

          foreach($file in $files) {
            $name  $file.name
            $name_without_extension  $name.replace('.json','')
            $full_path  $datasetFolder + $name
            $dataset_body  (Get-Content "$full_path") | Out-String
            $api_url  "https://${{ env.synapseWorkspaceName }}.dev.azuresynapse.net/datasets/"+$name_without_extension+"?api-version2020-12-01"
            Invoke-RestMethod -Method 'PUT' -Uri $api_url -Headers $headers -Body $dataset_body
          }

          $dataflowFolder  "$AcceleratorGitHubPath/synapse_adf_artifacts/dataflows/"
          $files  Get-ChildItem -Path "$dataflowFolder" -Exclude "NotDeployed"

          foreach($file in $files) {
            $name  $file.name
            $name_without_extension  $name.replace('.json','')
            $full_path  $dataflowFolder + $name
            Set-AzSynapseDataFlow -WorkspaceName ${{ env.synapseWorkspaceName }} -Name $name_without_extension -DefinitionFile "$full_path"
          }

          $pipelineFolder  "$AcceleratorGitHubPath/synapse_adf_artifacts/pipelines/"
          $files  Get-ChildItem -Path "$pipelineFolder" -Exclude "NotDeployed", "*_ADF.json" | Sort-Object -Property Name -Descending

          foreach($file in $files) {
            $name  $file.name
            $name_without_extension  $name.replace('_Synapse.json','').replace('.json','')
            $full_path  $pipelineFolder + $name
            $pipeline_body  (Get-Content "$full_path") | Out-String
            $api_url  "https://${{ env.synapseWorkspaceName }}.dev.azuresynapse.net/pipelines/"+$name_without_extension+"?api-version2020-12-01"
            Invoke-RestMethod -Method 'PUT' -Uri $api_url -Headers $headers -Body $pipeline_body
          }

          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/triggers/TR_blobCreatedEvent.json) -Replace 'resourceGroupName', '${{ env.PrimaryRgName }}' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/triggers/TR_blobCreatedEvent.json
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/triggers/TR_blobCreatedEvent.json) -Replace 'subID', '${{ secrets.SUBSCRIPTION_ID }}' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/triggers/TR_blobCreatedEvent.json
          (Get-Content $AcceleratorGitHubPath/synapse_adf_artifacts/triggers/TR_blobCreatedEvent.json) -Replace 'landingStorageName', '${{ env.landingStorageName }}' | Set-Content $AcceleratorGitHubPath/synapse_adf_artifacts/triggers/TR_blobCreatedEvent.json
          Set-AzSynapseTrigger  -WorkspaceName ${{ env.synapseWorkspaceName }} -Name 'TR_blobCreatedEvent' -DefinitionFile "$AcceleratorGitHubPath/synapse_adf_artifacts/triggers/TR_blobCreatedEvent.json"
          # start trigger
          Start-AzSynapseTrigger -WorkspaceName ${{ env.synapseWorkspaceName }} -Name TR_blobCreatedEvent -AsJob
        azurePowerShellVersion: 'LatestVersion'

    - task: AzurePowerShell@5
      displayName: 'Approve Data Factory Private Endpoint to Data Lake Storage Account - Blob Endpoint'
      if: ${{ eq(env.DeployADF, 'True') && eq(env.DeployDataLake, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          $endpointList  Get-AzPrivateEndpointConnection -PrivateLinkResourceId "/subscriptions/${{ secrets.SUBSCRIPTION_ID }}/resourceGroups/${{ env.PrimaryRgName }}/providers/Microsoft.Storage/storageAccounts/${{ env.dataLakeName }}" 
          $privateEndpoint  $endpointList | Where-Object { $_.PrivateEndpoint.Id.EndsWith('${{ env.dataFactoryName }}.MPE_DataLake_Blob') -and $_.PrivateLinkServiceConnectionState.Status -EQ 'Pending' }
          if ( [string]::IsNullOrEmpty($privateEndpoint) ) { 
            Write-Output "No Private Endpoint to Approve"
          } else {
            $privateEndpointId  $privateEndpoint.Id
            Approve-AzPrivateEndpointConnection -ResourceId $privateEndpointId
          }
        azurePowerShellVersion: 'LatestVersion'
    
    - task: AzurePowerShell@5
      displayName: 'Approve Data Factory Private Endpoint to Data Lake Storage Account - DFS Endpoint'
      if: ${{ eq(env.DeployADF, 'True') && eq(env.DeployDataLake, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          $endpointList  Get-AzPrivateEndpointConnection -PrivateLinkResourceId "/subscriptions/${{ secrets.SUBSCRIPTION_ID }}/resourceGroups/${{ env.PrimaryRgName }}/providers/Microsoft.Storage/storageAccounts/${{ env.dataLakeName }}" 
          $privateEndpoint  $endpointList | Where-Object { $_.PrivateEndpoint.Id.EndsWith('${{ env.dataFactoryName }}.MPE_DataLake_DFS') -and $_.PrivateLinkServiceConnectionState.Status -EQ 'Pending' }
          if ( [string]::IsNullOrEmpty($privateEndpoint) ) { 
            Write-Output "No Private Endpoint to Approve"
          } else {
            $privateEndpointId  $privateEndpoint.Id
            Approve-AzPrivateEndpointConnection -ResourceId $privateEndpointId
          }
        azurePowerShellVersion: 'LatestVersion'
    
    - task: AzurePowerShell@5
      displayName: 'Approve Data Factory Private Endpoint to Landing Storage Account - Blob Endpoint'
      if: ${{ eq(env.DeployADF, 'True') && eq(env.DeployLandingStorage, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          $endpointList  Get-AzPrivateEndpointConnection -PrivateLinkResourceId "/subscriptions/${{ secrets.SUBSCRIPTION_ID }}/resourceGroups/${{ env.PrimaryRgName }}/providers/Microsoft.Storage/storageAccounts/${{ env.landingStorageName }}" 
          $privateEndpoint  $endpointList | Where-Object { $_.PrivateEndpoint.Id.EndsWith('${{ env.dataFactoryName }}.MPE_LandingStorage_Blob') -and $_.PrivateLinkServiceConnectionState.Status -EQ 'Pending' }
          if ( [string]::IsNullOrEmpty($privateEndpoint) ) { 
            Write-Output "No Private Endpoint to Approve"
          } else {
            $privateEndpointId  $privateEndpoint.Id
            Approve-AzPrivateEndpointConnection -ResourceId $privateEndpointId
          }
        azurePowerShellVersion: 'LatestVersion'

    - task: AzurePowerShell@5
      displayName: 'Approve Data Factory Private Endpoint to Landing Storage Account - DFS Endpoint'
      if: ${{ eq(env.DeployADF, 'True') && eq(env.DeployLandingStorage, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          $endpointList  Get-AzPrivateEndpointConnection -PrivateLinkResourceId "/subscriptions/${{ secrets.SUBSCRIPTION_ID }}/resourceGroups/${{ env.PrimaryRgName }}/providers/Microsoft.Storage/storageAccounts/${{ env.landingStorageName }}" 
          $privateEndpoint  $endpointList | Where-Object { $_.PrivateEndpoint.Id.EndsWith('${{ env.dataFactoryName }}.MPE_LandingStorage_DFS') -and $_.PrivateLinkServiceConnectionState.Status -EQ 'Pending' }
          if ( [string]::IsNullOrEmpty($privateEndpoint) ) { 
            Write-Output "No Private Endpoint to Approve"
          } else {
            $privateEndpointId  $privateEndpoint.Id
            Approve-AzPrivateEndpointConnection -ResourceId $privateEndpointId
          }
        azurePowerShellVersion: 'LatestVersion'
      
    - task: AzurePowerShell@5
      displayName: 'Approve Data Factory Private Endpoint to Azure SQL'
      if: ${{ eq(env.DeployADF, 'True') && eq(env.DeployAzureSQL, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          $endpointList  Get-AzPrivateEndpointConnection -PrivateLinkResourceId "/subscriptions/${{ secrets.SUBSCRIPTION_ID }}/resourceGroups/${{ env.PrimaryRgName }}/providers/Microsoft.Sql/servers/${{ env.azureSQLServerName }}" 
          $privateEndpoint  $endpointList | Where-Object { $_.PrivateEndpoint.Id.EndsWith('${{ env.dataFactoryName }}.MPE_AzureSQL') -and $_.PrivateLinkServiceConnectionState.Status -EQ 'Pending' }
          if ( [string]::IsNullOrEmpty($privateEndpoint) ) { 
            Write-Output "No Private Endpoint to Approve"
          } else {
            $privateEndpointId  $privateEndpoint.Id
            Approve-AzPrivateEndpointConnection -ResourceId $privateEndpointId
          }
        azurePowerShellVersion: 'LatestVersion'

    - task: AzurePowerShell@5
      displayName: 'Approve Data Factory Private Endpoint to Key Vault'
      if: ${{ eq(env.DeployADF, 'True') && eq(env.DeployKeyVault, 'True') }} 
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          $endpointList  Get-AzPrivateEndpointConnection -PrivateLinkResourceId "/subscriptions/${{ secrets.SUBSCRIPTION_ID }}/resourceGroups/${{ env.PrimaryRgName }}/providers/Microsoft.KeyVault/vaults/${{ env.keyVaultName }}" 
          $privateEndpoint  $endpointList | Where-Object { $_.PrivateEndpoint.Id.EndsWith('${{ env.dataFactoryName }}.MPE_KeyVault') -and $_.PrivateLinkServiceConnectionState.Status -EQ 'Pending' }
          if ( [string]::IsNullOrEmpty($privateEndpoint) ) { 
            Write-Output "No Private Endpoint to Approve"
          } else {
            $privateEndpointId  $privateEndpoint.Id
            Approve-AzPrivateEndpointConnection -ResourceId $privateEndpointId
          }
        azurePowerShellVersion: 'LatestVersion'
    
    - task: AzurePowerShell@5
      displayName: 'Approve Data Factory Private Endpoint to Purview'
      if: ${{ eq(env.DeployADF, 'True') && eq(env.DeployPurview, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          $endpointList  Get-AzPrivateEndpointConnection -PrivateLinkResourceId "/subscriptions/${{ secrets.SUBSCRIPTION_ID }}/resourceGroups/${{ env.PrimaryRgName }}/providers/Microsoft.Purview/accounts/${{ env.purviewName }}"
          $privateEndpoint  $endpointList | Where-Object { $_.PrivateEndpoint.Id.EndsWith('${{ env.dataFactoryName }}.MPE_Purview') -and $_.PrivateLinkServiceConnectionState.Status -EQ 'Pending' }
          if ( [string]::IsNullOrEmpty($privateEndpoint) ) { 
            Write-Output "No Private Endpoint to Approve"
          } else {
            $privateEndpointId  $privateEndpoint.Id
            Approve-AzPrivateEndpointConnection -ResourceId $privateEndpointId -Description "Approve for connection to ${{ env.dataFactoryName }}"
          }

          if ("${{ env.ServicePrincipalHasOwnerRBACAtSubscription }}" -eq "True") { 
            $purview  Get-AzResource -Name ${{ env.purviewName }} -ResourceGroupName ${{ env.PrimaryRgName }} -ResourceType Microsoft.Purview/accounts -ExpandProperties
            $purviewStorageResourceId  $purview.Properties.managedResources.storageAccount

            $endpointList  Get-AzPrivateEndpointConnection -PrivateLinkResourceId "$purviewStorageResourceId"
            $privateEndpoint  $endpointList | Where-Object { $_.PrivateEndpoint.Id.EndsWith('${{ env.dataFactoryName }}.MPE_PurviewStorage_Blob') -and $_.PrivateLinkServiceConnectionState.Status -EQ 'Pending' }
            if ( [string]::IsNullOrEmpty($privateEndpoint) ) { 
              Write-Output "No Private Endpoint to Approve"
            } else {
              $privateEndpointId  $privateEndpoint.Id
              Approve-AzPrivateEndpointConnection -ResourceId $privateEndpointId -Description "Approve for connection to ${{ env.dataFactoryName }}"
            }

            $endpointList  Get-AzPrivateEndpointConnection -PrivateLinkResourceId "$purviewStorageResourceId"
            $privateEndpoint  $endpointList | Where-Object { $_.PrivateEndpoint.Id.EndsWith('${{ env.dataFactoryName }}.MPE_PurviewStorage_Queue') -and $_.PrivateLinkServiceConnectionState.Status -EQ 'Pending' }
            if ( [string]::IsNullOrEmpty($privateEndpoint) ) { 
              Write-Output "No Private Endpoint to Approve"
            } else {
              $privateEndpointId  $privateEndpoint.Id
              Approve-AzPrivateEndpointConnection -ResourceId $privateEndpointId -Description "Approve for connection to ${{ env.dataFactoryName }}"
            }
          }
        azurePowerShellVersion: 'LatestVersion'
    
    - task: AzurePowerShell@5
      displayName: 'Approve Data Factory Private Endpoint to Cognitive Service'
      if: ${{ eq(env.DeployADF, 'True') && eq(env.DeployCognitiveService, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          $endpointList  Get-AzPrivateEndpointConnection -PrivateLinkResourceId "/subscriptions/${{ secrets.SUBSCRIPTION_ID }}/resourceGroups/${{ env.PrimaryRgName }}/providers/Microsoft.CognitiveServices/accounts/${{ env.cognitiveServiceName }}"
          $privateEndpoint  $endpointList | Where-Object { $_.PrivateEndpoint.Id.EndsWith('${{ env.dataFactoryName }}.MPE_CognitiveService') -and $_.PrivateLinkServiceConnectionState.Status -EQ 'Pending' }
          if ( [string]::IsNullOrEmpty($privateEndpoint) ) { 
            Write-Output "No Private Endpoint to Approve"
          } else {
            $privateEndpointId  $privateEndpoint.Id
            Approve-AzPrivateEndpointConnection -ResourceId $privateEndpointId -Description "Approve for connection to ${{ env.dataFactoryName }}"
          }
        azurePowerShellVersion: 'LatestVersion'
    
    - task: AzurePowerShell@5
      displayName: 'Approve Data Factory Private Endpoint to Synapse'
      if: ${{ eq(env.DeployADF, 'True') && eq(env.DeploySynapse, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          $endpointList  Get-AzPrivateEndpointConnection -PrivateLinkResourceId "/subscriptions/${{ secrets.SUBSCRIPTION_ID }}/resourceGroups/${{ env.PrimaryRgName }}/providers/Microsoft.Synapse/workspaces/${{ env.synapseWorkspaceName }}"
          $privateEndpoint  $endpointList | Where-Object { $_.PrivateEndpoint.Id.EndsWith('${{ env.dataFactoryName }}.MPE_Synapse') -and $_.PrivateLinkServiceConnectionState.Status -EQ 'Pending' }
          if ( [string]::IsNullOrEmpty($privateEndpoint) ) { 
            Write-Output "No Private Endpoint to Approve"
          } else {
            $privateEndpointId  $privateEndpoint.Id
            Approve-AzPrivateEndpointConnection -ResourceId $privateEndpointId
          }
        azurePowerShellVersion: 'LatestVersion'

    - task: AzurePowerShell@5
      displayName: 'Approve Synapse Private Endpoint to Data Lake Storage Account - DFS Endpoint'
      if: ${{ eq(env.DeployADF, 'True') && eq(env.DeployDataLake, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          $endpointList  Get-AzPrivateEndpointConnection -PrivateLinkResourceId "/subscriptions/${{ secrets.SUBSCRIPTION_ID }}/resourceGroups/${{ env.PrimaryRgName }}/providers/Microsoft.Storage/storageAccounts/${{ env.dataLakeName }}" 
          $privateEndpoint  $endpointList | Where-Object { $_.PrivateEndpoint.Id.EndsWith('${{ env.synapseWorkspaceName }}.MPE_DataLake_DFS') -and $_.PrivateLinkServiceConnectionState.Status -EQ 'Pending' }
          if ( [string]::IsNullOrEmpty($privateEndpoint) ) { 
            Write-Output "No Private Endpoint to Approve"
          } else {
            $privateEndpointId  $privateEndpoint.Id
            Approve-AzPrivateEndpointConnection -ResourceId $privateEndpointId
          }
        azurePowerShellVersion: 'LatestVersion'

    - task: AzurePowerShell@5
      displayName: 'Approve Synapse Private Endpoint to Data Lake Storage Account - Blob Endpoint'
      if: ${{ eq(env.DeployADF, 'True') && eq(env.DeployDataLake, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          $endpointList  Get-AzPrivateEndpointConnection -PrivateLinkResourceId "/subscriptions/${{ secrets.SUBSCRIPTION_ID }}/resourceGroups/${{ env.PrimaryRgName }}/providers/Microsoft.Storage/storageAccounts/${{ env.dataLakeName }}" 
          $privateEndpoint  $endpointList | Where-Object { $_.PrivateEndpoint.Id.EndsWith('${{ env.synapseWorkspaceName }}.MPE_DataLake_Blob') -and $_.PrivateLinkServiceConnectionState.Status -EQ 'Pending' }
          if ( [string]::IsNullOrEmpty($privateEndpoint) ) { 
            Write-Output "No Private Endpoint to Approve"
          } else {
            $privateEndpointId  $privateEndpoint.Id
            Approve-AzPrivateEndpointConnection -ResourceId $privateEndpointId
          }
        azurePowerShellVersion: 'LatestVersion'
    
    - task: AzurePowerShell@5
      displayName: 'Approve Synapse Private Endpoint to Landing Storage Account - DFS Endpoint'
      if: ${{ eq(env.DeployADF, 'True') && eq(env.DeployLandingStorage, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          $endpointList  Get-AzPrivateEndpointConnection -PrivateLinkResourceId "/subscriptions/${{ secrets.SUBSCRIPTION_ID }}/resourceGroups/${{ env.PrimaryRgName }}/providers/Microsoft.Storage/storageAccounts/${{ env.landingStorageName }}" 
          $privateEndpoint  $endpointList | Where-Object { $_.PrivateEndpoint.Id.EndsWith('${{ env.synapseWorkspaceName }}.MPE_LandingStorage_DFS') -and $_.PrivateLinkServiceConnectionState.Status -EQ 'Pending' }
          if ( [string]::IsNullOrEmpty($privateEndpoint) ) { 
            Write-Output "No Private Endpoint to Approve"
          } else {
            $privateEndpointId  $privateEndpoint.Id
            Approve-AzPrivateEndpointConnection -ResourceId $privateEndpointId
          }
        azurePowerShellVersion: 'LatestVersion'
    
    - task: AzurePowerShell@5
      displayName: 'Approve Synapse Private Endpoint to Landing Storage Account - Blob Endpoint'
      if: ${{ eq(env.DeployADF, 'True') && eq(env.DeployLandingStorage, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          $endpointList  Get-AzPrivateEndpointConnection -PrivateLinkResourceId "/subscriptions/${{ secrets.SUBSCRIPTION_ID }}/resourceGroups/${{ env.PrimaryRgName }}/providers/Microsoft.Storage/storageAccounts/${{ env.landingStorageName }}" 
          $privateEndpoint  $endpointList | Where-Object { $_.PrivateEndpoint.Id.EndsWith('${{ env.synapseWorkspaceName }}.MPE_LandingStorage_Blob') -and $_.PrivateLinkServiceConnectionState.Status -EQ 'Pending' }
          if ( [string]::IsNullOrEmpty($privateEndpoint) ) { 
            Write-Output "No Private Endpoint to Approve"
          } else {
            $privateEndpointId  $privateEndpoint.Id
            Approve-AzPrivateEndpointConnection -ResourceId $privateEndpointId
          }
        azurePowerShellVersion: 'LatestVersion'

    - task: AzurePowerShell@5
      displayName: 'Approve Synapse Private Endpoint to Azure SQL'
      if: ${{ eq(env.DeployADF, 'True') && eq(env.DeployAzureSQL, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          $endpointList  Get-AzPrivateEndpointConnection -PrivateLinkResourceId "/subscriptions/${{ secrets.SUBSCRIPTION_ID }}/resourceGroups/${{ env.PrimaryRgName }}/providers/Microsoft.Sql/servers/${{ env.azureSQLServerName }}" 
          $privateEndpoint  $endpointList | Where-Object { $_.PrivateEndpoint.Id.EndsWith('${{ env.synapseWorkspaceName }}.MPE_AzureSQL') -and $_.PrivateLinkServiceConnectionState.Status -EQ 'Pending' }
          if ( [string]::IsNullOrEmpty($privateEndpoint) ) { 
            Write-Output "No Private Endpoint to Approve"
          } else {
            $privateEndpointId  $privateEndpoint.Id
            Approve-AzPrivateEndpointConnection -ResourceId $privateEndpointId
          }
        azurePowerShellVersion: 'LatestVersion'

    - task: AzurePowerShell@5
      displayName: 'Approve Synapse Private Endpoint to Key Vault'
      if: ${{ eq(env.DeployADF, 'True') && eq(env.DeployKeyVault, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          $endpointList  Get-AzPrivateEndpointConnection -PrivateLinkResourceId "/subscriptions/${{ secrets.SUBSCRIPTION_ID }}/resourceGroups/${{ env.PrimaryRgName }}/providers/Microsoft.KeyVault/vaults/${{ env.keyVaultName }}"
          $privateEndpoint  $endpointList | Where-Object { $_.PrivateEndpoint.Id.EndsWith('${{ env.synapseWorkspaceName }}.MPE_KeyVault') -and $_.PrivateLinkServiceConnectionState.Status -EQ 'Pending' }
          if ( [string]::IsNullOrEmpty($privateEndpoint) ) { 
            Write-Output "No Private Endpoint to Approve"
          } else {
            $privateEndpointId  $privateEndpoint.Id
            Approve-AzPrivateEndpointConnection -ResourceId $privateEndpointId
          }
        azurePowerShellVersion: 'LatestVersion'

    - task: AzurePowerShell@5
      displayName: 'Approve Synapse Private Endpoint to Purview'
      if: ${{ eq(env.DeployADF, 'True') && eq(env.DeployPurview, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          $endpointList  Get-AzPrivateEndpointConnection -PrivateLinkResourceId "/subscriptions/${{ secrets.SUBSCRIPTION_ID }}/resourceGroups/${{ env.PrimaryRgName }}/providers/Microsoft.Purview/accounts/${{ env.purviewName }}"
          $privateEndpoint  $endpointList | Where-Object { $_.PrivateEndpoint.Id.EndsWith('${{ env.synapseWorkspaceName }}.MPE_Purview') -and $_.PrivateLinkServiceConnectionState.Status -EQ 'Pending' }
          if ( [string]::IsNullOrEmpty($privateEndpoint) ) { 
            Write-Output "No Private Endpoint to Approve"
          } else {
            $privateEndpointId  $privateEndpoint.Id
            Approve-AzPrivateEndpointConnection -ResourceId $privateEndpointId -Description "Approve for connection to ${{ env.synapseWorkspaceName }}"
          }

          if ("${{ env.ServicePrincipalHasOwnerRBACAtSubscription }}" -eq "True") { 
            $purview  Get-AzResource -Name ${{ env.purviewName }} -ResourceGroupName ${{ env.PrimaryRgName }} -ResourceType Microsoft.Purview/accounts -ExpandProperties
            $purviewStorageResourceId  $purview.Properties.managedResources.storageAccount

            $endpointList  Get-AzPrivateEndpointConnection -PrivateLinkResourceId "$purviewStorageResourceId"
            $privateEndpoint  $endpointList | Where-Object { $_.PrivateEndpoint.Id.EndsWith('${{ env.synapseWorkspaceName }}.MPE_PurviewStorage_Blob') -and $_.PrivateLinkServiceConnectionState.Status -EQ 'Pending' }
            if ( [string]::IsNullOrEmpty($privateEndpoint) ) { 
              Write-Output "No Private Endpoint to Approve"
            } else {
              $privateEndpointId  $privateEndpoint.Id
              Approve-AzPrivateEndpointConnection -ResourceId $privateEndpointId -Description "Approve for connection to ${{ env.synapseWorkspaceName }}"
            }

            $endpointList  Get-AzPrivateEndpointConnection -PrivateLinkResourceId "$purviewStorageResourceId"
            $privateEndpoint  $endpointList | Where-Object { $_.PrivateEndpoint.Id.EndsWith('${{ env.synapseWorkspaceName }}.MPE_PurviewStorage_Queue') -and $_.PrivateLinkServiceConnectionState.Status -EQ 'Pending' }
            if ( [string]::IsNullOrEmpty($privateEndpoint) ) { 
              Write-Output "No Private Endpoint to Approve"
            } else {
              $privateEndpointId  $privateEndpoint.Id
              Approve-AzPrivateEndpointConnection -ResourceId $privateEndpointId -Description "Approve for connection to ${{ env.synapseWorkspaceName }}"
            }
          }
        azurePowerShellVersion: 'LatestVersion'

    - task: AzurePowerShell@5
      displayName: 'Approve Synapse Private Endpoint to ML Workspace'
      if: ${{ eq(env.DeployADF, 'True') && eq(env.DeployCognitiveService, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          $endpointList  Get-AzPrivateEndpointConnection -PrivateLinkResourceId "/subscriptions/${{ secrets.SUBSCRIPTION_ID }}/resourceGroups/${{ env.PrimaryRgName }}/providers/Microsoft.CognitiveServices/accounts/${{ env.cognitiveServiceName }}"
          $privateEndpoint  $endpointList | Where-Object { $_.PrivateEndpoint.Id.EndsWith('${{ env.synapseWorkspaceName }}.MPE_CognitiveService') -and $_.PrivateLinkServiceConnectionState.Status -EQ 'Pending' }
          if ( [string]::IsNullOrEmpty($privateEndpoint) ) { 
            Write-Output "No Private Endpoint to Approve"
          } else {
            $privateEndpointId  $privateEndpoint.Id
            Approve-AzPrivateEndpointConnection -ResourceId $privateEndpointId -Description "Approve for connection to ${{ env.synapseWorkspaceName }}"
          }
        azurePowerShellVersion: 'LatestVersion'

    - task: AzureResourceManagerTemplateDeployment@3
      displayName: Deploy RBAC
      if: ${{ eq(env.Assign_RBAC_On_Deployment, 'True') }}
      inputs:
        deploymentScope: 'Resource Group'
        azureResourceManagerConnection: 'ADOTestSubcription'
        resourceGroupName: ${{ env.PrimaryRgName }}
        location: ${{ env.azureResourceLocation }}
        templateLocation: 'FilePath'
        csmFile: '$AcceleratorGitHubPath/bicep_templates/rbac_dsdeployment_orchestrator.bicep'
        overrideParameters: >
          -env ${{inputs.envFolderPath }}
          -Service_Principal_Infra_Object_ID ${{ env.servicePrincipalObjectId  }}
          -Assign_RBAC_for_CICD_Service_Principal ${{ env.Assign_RBAC_for_CICD_Service_Principal }}
          -Service_Principal_CICD_Object_ID${{ env.Service_Principal_CICD_Object_ID }}
          -Entra_Group_Admin_Group_ID ${{ env.Entra_Group_Admin_ID }}
          -Entra_Group_Shared_Service_Group_ID ${{ env.Entra_Group_Shared_Service_ID }}
          -Assign_RBAC_for_Governance ${{ env.Assign_RBAC_for_Governance }}
          -Entra_Group_Governance_Group_ID ${{ env.Entra_Group_Governance_ID }}
          -Assign_RBAC_for_Publishers ${{ env.Assign_RBAC_for_Publishers }}
          -Entra_Groups_Data_Publishers ${{ env.Entra_Groups_Data_Publishers_Json }}
          -Assign_RBAC_for_Producers ${{ env.Assign_RBAC_for_Producers }}
          -Entra_Groups_Data_Producers ${{ env.Entra_Groups_Data_Producers_Json }}
          -Assign_RBAC_for_Consumers ${{ env.Assign_RBAC_for_Consumers }}
          -Entra_Groups_Data_Consumers ${{ env.Entra_Groups_Data_Consumers_Json }}
          -PrimaryRgName ${{ env.PrimaryRgName }}
          -DeployDataLake ${{ env.DeployDataLake }}
          -dataLakeName ${{ env.dataLakeName }}
          -DeployLandingStorage ${{ env.DeployLandingStorage }}
          -landingStorageName ${{ env.landingStorageName }}
          -DeployPurview ${{ env.DeployPurview }}
          -purviewName ${{ env.purviewName }}
          -DeployKeyVault ${{ env.DeployKeyVault }}
          -keyVaultName ${{ env.keyVaultName }}
          -DeployADF ${{ env.DeployADF }}
          -dataFactoryName ${{ env.dataFactoryName }}
          -DeploySynapse ${{ env.DeploySynapse }}
          -synapseWorkspaceName ${{ env.synapseWorkspaceName }}
          -DeployCognitiveService ${{ env.DeployCognitiveService }}
          -cognitiveServiceName ${{ env.cognitiveServiceName }}
          -DeployEventHubNamespace ${{ env.DeployEventHubNamespace }}
          -eventHubNamespaceName ${{ env.eventHubNamespaceName }}
          -DeployStreamAnalytics ${{ env.DeployStreamAnalytics }}
          -streamAnalyticsName ${{ env.streamAnalyticsName }}
          -DeployLogicApp ${{ env.DeployLogicApp }}
          -logicAppRG ${{ env.LogicAppRgName }}
          -logicAppName ${{ env.logicAppName }}
          -DeployMLWorkspace ${{ env.DeployMLWorkspace }}
          -MlRgName ${{ env.MlRgName }}
          -mlWorkspaceName ${{ env.mlWorkspaceName }}         
        deploymentMode: 'Incremental'
        deploymentName: 'MLWorkspaceDeployment'

    - task: AzurePowerShell@5
      displayName: 'Assign ACLs for Data Publishers on Folders in Landing Zone'
      if: ${{ eq(env.Assign_RBAC_On_Deployment, 'True') && eq(env.Assign_RBAC_for_Publishers, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          $ctx  New-AzStorageContext -StorageAccountName '${{ env.landingStorageName }}' -UseConnectedAccount
          $filesystemName  "landing"
          
          $Entra_Groups_Data_Publishers_HashTable  '${{ env.Entra_Groups_Data_Publishers }}' | ConvertFrom-Json
          foreach ( $publisher in $Entra_Groups_Data_Publishers_HashTable ) {
              $EntityID  $publisher.Group_ID
              $acl  (Get-AzDataLakeGen2Item -Context $ctx -FileSystem $filesystemName).ACL
              $acl  Set-AzDataLakeGen2ItemAclObject -AccessControlType group -EntityID $EntityID -Permission --x -InputObject $acl -DefaultScope
              Update-AzDataLakeGen2Item -Context $ctx -FileSystem $filesystemName -Acl $acl
              $all_storage_paths  $publisher.Storage_Paths_Write_Access
            foreach ( $path in $all_storage_paths ) {
              $exists  az storage fs directory exists --account-name ${{ env.landingStorageName }} --auth-mode login --file-system $filesystemName --name $path | ConvertFrom-Json
              if ($exists.exists -ne $true) {
                az storage fs directory create --account-name ${{ env.landingStorageName }} --auth-mode login --file-system $filesystemName --name $path
              }
              $all_directories  "$path" -split "/" -ne ""
              $path_update  ""
              foreach ( $directory in $all_directories ) {
                $path_update  $path_update + $directory + '/'
                $acl  (Get-AzDataLakeGen2Item -Context $ctx -FileSystem $filesystemName -Path $path_update).ACL
                $acl  Set-AzDataLakeGen2ItemAclObject -AccessControlType group -EntityID $EntityID -Permission --x -InputObject $acl -DefaultScope
                Update-AzDataLakeGen2Item -Context $ctx -FileSystem $filesystemName -Path $path_update -Acl $acl                
              }
              $acl  (Get-AzDataLakeGen2Item -Context $ctx -FileSystem $filesystemName -Path $path).ACL
              $acl  Set-AzDataLakeGen2ItemAclObject -AccessControlType group -EntityID $EntityID -Permission rwx -InputObject $acl -DefaultScope
              Update-AzDataLakeGen2Item -Context $ctx -FileSystem $filesystemName -Path $path -Acl $acl

              $acl  (Get-AzDataLakeGen2Item -Context $ctx -FileSystem $filesystemName -Path $path).ACL
              $acl  Set-AzDataLakeGen2ItemAclObject -AccessControlType group -EntityID $EntityID -Permission rwx -InputObject $acl
              Update-AzDataLakeGen2AclRecursive -Context $ctx -FileSystem $filesystemName -Path $path -Acl $acl
            }
          }
        azurePowerShellVersion: 'LatestVersion'

    - task: AzurePowerShell@5
      displayName: 'Assign ACLs for Data Producers on Folders in Curated Zone'
      if: ${{ eq(env.Assign_RBAC_On_Deployment, 'True') && eq(env.Assign_RBAC_for_Producers, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          $ctx  New-AzStorageContext -StorageAccountName '${{ env.dataLakeName }}' -UseConnectedAccount
          $filesystemName  "curated"
          
          $Entra_Groups_Data_Producers_HashTable  '${{ env.Entra_Groups_Data_Producers }}' | ConvertFrom-Json
          foreach ( $producer in $Entra_Groups_Data_Producers_HashTable ) {
              $EntityID  $producer.Group_ID
              $acl  (Get-AzDataLakeGen2Item -Context $ctx -FileSystem $filesystemName).ACL
              $acl  Set-AzDataLakeGen2ItemAclObject -AccessControlType group -EntityID $EntityID -Permission --x -InputObject $acl -DefaultScope
              Update-AzDataLakeGen2Item -Context $ctx -FileSystem $filesystemName -Acl $acl
              $all_storage_paths  $producer.Storage_Paths_Write_Access
            foreach ( $path in $all_storage_paths ) {
              $exists  az storage fs directory exists --account-name ${{ env.dataLakeName }} --auth-mode login --file-system $filesystemName --name $path | ConvertFrom-Json
              if ($exists.exists -ne $true) {
                az storage fs directory create --account-name ${{ env.dataLakeName }} --auth-mode login --file-system $filesystemName --name $path
              }
              $all_directories  "$path" -split "/" -ne ""
              $path_update  ""
              foreach ( $directory in $all_directories ) {
                $path_update  $path_update + $directory + '/'
                $acl  (Get-AzDataLakeGen2Item -Context $ctx -FileSystem $filesystemName -Path $path_update).ACL
                $acl  Set-AzDataLakeGen2ItemAclObject -AccessControlType group -EntityID $EntityID -Permission --x -InputObject $acl -DefaultScope
                Update-AzDataLakeGen2Item -Context $ctx -FileSystem $filesystemName -Path $path_update -Acl $acl                
              }
              $acl  (Get-AzDataLakeGen2Item -Context $ctx -FileSystem $filesystemName -Path $path).ACL
              $acl  Set-AzDataLakeGen2ItemAclObject -AccessControlType group -EntityID $EntityID -Permission rwx -InputObject $acl -DefaultScope
              Update-AzDataLakeGen2Item -Context $ctx -FileSystem $filesystemName -Path $path -Acl $acl
              Update-AzDataLakeGen2AclRecursive -Context $ctx -FileSystem $filesystemName -Path $path -Acl $acl
            }
          }ne: |
        # give ADF Contributor and Credential User rights to Synapse
        if ("${{ env.DeployMetadataDrivenPipelinesToSynapse }}" -eq "False" -and "${{ env.DeployADF }}" -eq "True") { 
          $dataFactoryDetails  Get-AzDataFactoryV2 -name "${{ env.dataFactoryName }}" -ResourceGroupName "${{ env.PrimaryRgName }}"
          $adfSpId  $dataFactoryDetails.Identity.PrincipalId.Guid
          az synapse role assignment create --workspace-name ${{ env.synapseWorkspaceName }} --role "Synapse Contributor" --assignee $adfSpId
          az synapse role assignment create --workspace-name ${{ env.synapseWorkspaceName }} --role "Synapse Credential User" --assignee $adfSpId
        }
        # give AAD group admin rights to Synapse
        # all other Synapse RBAC need to go before AAD Group Synapse RBAC
        az synapse role assignment create --workspace-name ${{ env.synapseWorkspaceName }} --role "Synapse Administrator" --assignee ${{ env.Entra_Group_Admin_ID }}
        az synapse role assignment create --workspace-name ${{ env.synapseWorkspaceName }} --role "Synapse SQL Administrator" --assignee ${{ env.Entra_Group_Shared_Service_ID }}
        az synapse role assignment create --workspace-name ${{ env.synapseWorkspaceName }} --role "Synapse Contributor" --assignee ${{ env.Entra_Group_Shared_Service_ID }}
        az synapse role assignment create --workspace-name ${{ env.synapseWorkspaceName }} --role "Synapse Credential User" --assignee ${{ env.Entra_Group_Shared_Service_ID }}
        Set-AzSynapseSqlActiveDirectoryAdministrator -WorkspaceName ${{ env.synapseWorkspaceName }} -ObjectId ${{  env.Entra_Group_Admin_ID }}
        azurePowerShellVersion: 'LatestVersion'

    - task: AzurePowerShell@5
      displayName: 'Create SQL File in Synapse for Serverless SQL Pool and SP's for Logic App'
      if: ${{ eq(env.DeploySynapseSqlPools, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          (Get-Content $AcceleratorGithubPath/synapse_adf_artifacts/serverless/stored_procedures/z_addmanagedidentities.sql) -Replace 'storageAccountName', '${{ env.dataLakeName }}' | Set-Content $AcceleratorGithubPath/synapse_adf_artifacts/serverless/stored_procedures/z_addmanagedidentities.sql
          (Get-Content $AcceleratorGithubPath/synapse_adf_artifacts/serverless/stored_procedures/z_addmanagedidentities.sql) -Replace 'insert_logicapp_name', '${{ env.logicAppName }}' | Set-Content $AcceleratorGithubPath/synapse_adf_artifacts/serverless/stored_procedures/z_addmanagedidentities.sql
          (Get-Content $AcceleratorGithubPath/synapse_adf_artifacts/serverless/stored_procedures/z_addmanagedidentities.sql) -Replace 'insert_synapse_name', '${{ env.synapseWorkspaceName }}' | Set-Content $AcceleratorGithubPath/synapse_adf_artifacts/serverless/stored_procedures/z_addmanagedidentities.sql
          (Get-Content $AcceleratorGithubPath/synapse_adf_artifacts/serverless/stored_procedures/z_addmanagedidentities.sql) -Replace 'insert_service_principal_name', '${{ env.servicePrincipalName }}' | Set-Content $AcceleratorGithubPath/synapse_adf_artifacts/serverless/stored_procedures/z_addmanagedidentities.sql
          Get-Content $AcceleratorGithubPath/synapse_adf_artifacts/serverless/*/*.sql | Set-Content $AcceleratorGithubPath/synapse_adf_artifacts/serverless/RunForLogicApp.sql
          $full_path  '$AcceleratorGithubPath/synapse_adf_artifacts/serverless/RunForLogicApp.sql'
          Set-AzSynapseSqlScript -WorkspaceName ${{ env.synapseWorkspaceName }} -DefinitionFile "$full_path" -SqlDatabaseName master -SqlPoolName "Built-in"
        azurePowerShellVersion: 'LatestVersion'

    - task: AzurePowerShell@5
      displayName: 'Remove Public Network Access to Resources That Required it During Deployment'
      if: ${{ eq(env.DeployResourcesWithPublicAccess, 'True') }}
      inputs:
        azureSubscription: 'ADOTestSubcription'
        ScriptType: 'InlineScript'
        Inline: |
          if ("${{ env.DeployWithCustomNetworking }}" -eq "True" -And "${{ env.AllowAccessToIpRange }}" -eq "True") { 
              Write-Output "Access is Set to Be Filtered to Specific IPs"
            } else {
              if ("${{ env.DeploySynapse }}" -eq "True") { 
                Update-AzSynapseWorkspace -Name ${{ env.synapseWorkspaceName }} -EnablePublicNetworkAccess $False
              }
              if ("${{ env.DeployAzureSQL }}" -eq "True") {
                az sql server update --resource-group ${{ env.PrimaryRgName }} --name ${{ env.azureSQLServerName }} --enable-public-network false
              }
              if ("${{ env.DeployLogicApp }}" -eq "True") {  
                Set-AzStorageAccount -ResourceGroupName "${{ env.LogicAppRgName }}" -Name "${{ env.logicAppStorageName }}" -PublicNetworkAccess "Disabled" -Force
              }
            }

            if ("${{ env.DeployADF }}" -eq "True") { 
              Update-AzDataFactoryV2 -ResourceGroupName ${{ env.PrimaryRgName }} -Name ${{ env.dataFactoryName }} -PublicNetworkAccess "Disabled"
            }
          
            if ("${{ env.DeployMLWorkspace }}" -eq "True") { 
              az extension add -n ml
              az ml workspace update --resource-group ${{ env.MlRgName }} --name ${{ env.mlWorkspaceName }} --public-network-access "Disabled"
            }
        azurePowerShellVersion: 'LatestVersion'

extends:
  - displayName: 'Deploy data science toolkit infrastructures'
    template: data_science_toolkit_infra.yml
    dependsOn: SynapseCreation
    parameters:
      environment: ${{ inputs.environment }}
      envFolderPath: ${{ inputs.envFolderPath }}
    secrets:
      TENANT_ID: ${{ secrets.TENANT_ID }}
      SUBSCRIPTION_ID: ${{ secrets.SUBSCRIPTION_ID }}
      SERVICE_PRINCIPAL_CLIENT_ID: ${{ secrets.SERVICE_PRINCIPAL_CLIENT_ID }}
      DNS_ZONE_SUBSCRIPTION_ID: ${{ secrets.DNS_ZONE_SUBSCRIPTION_ID }}
  - template: data_science_api_cicd.yml
    dependsOn: SynapseCreation && data_science_toolkit_infra.yml
    parameters:
      TargetBranch: ${{ parameters.TargetBranch }}
      TargetTag: ${{ parameters.TargetTag }}
  - template: data_science_portal_cicd.yml
    parameters:
      TargetBranch: ${{ parameters.TargetBranch }}
      TargetTag: ${{ parameters.TargetTag }}

- job: ApprovePrivateEndpointtoServices
  displayName: 'Approve private endpoint to services'
  dependsOn: SynapseCreation
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - checkout: self
    persistCredentials: true
    clean: true
    fetchDepth: 1

  - script: |
      git fetch --prune --tags
      git branch -r
      git checkout ${{ parameters.TargetBranch }}
      current_branch$(git rev-parse --abbrev-ref HEAD)
      echo "Current branch is: $current_branch"
    displayName: 'Switch to target branch'

  - script: |
      git checkout ${{ parameters.TargetTag }}
      current_tag$(git describe --tags --abbrev0)
      echo "Current tag is: $current_tag"
    displayName: 'Switch to target tag'

extends:
  - template: data_science_toolkit_infra.yml
    parameters:
      TargetBranch: ${{ parameters.TargetBranch }}
      TargetTag: ${{ parameters.TargetTag }}
  - template: data_science_api_cicd.yml
    parameters:
      TargetBranch: ${{ parameters.TargetBranch }}
      TargetTag: ${{ parameters.TargetTag }}
  - template: data_science_portal_cicd.yml
    parameters:
      TargetBranch: ${{ parameters.TargetBranch }}
      TargetTag: ${{ parameters.TargetTag }}

  